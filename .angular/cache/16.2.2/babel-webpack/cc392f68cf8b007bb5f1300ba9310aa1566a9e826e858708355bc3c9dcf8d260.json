{"ast":null,"code":"import _asyncToGenerator from \"/Users/chris/workspace/background-geolocation/cordova/SampleApp/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { NavigationStart } from '@angular/router';\nimport { isPlatform } from '@ionic/angular';\nimport { RegistrationPage } from './registration/registration.page';\nimport BackgroundGeolocation from \"../cordova-background-geolocation\";\nimport { environment } from \"../../environments/environment\";\nimport { registerTransistorAuthorizationListener } from \"../lib/authorization\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@ionic/angular\";\nimport * as i2 from \"@angular/router\";\nimport * as i3 from \"@angular/forms\";\nconst LocalStorage = window.localStorage;\n// Only allow alpha-numeric usernames with '-' and '_'\nconst USERNAME_VALIDATOR = /^[a-zA-Z0-9_-]*$/;\nlet HomePage = /*#__PURE__*/(() => {\n  var _class;\n  class HomePage {\n    constructor(modalController, alertCtrl, platform, router) {\n      this.modalController = modalController;\n      this.alertCtrl = alertCtrl;\n      this.platform = platform;\n      this.router = router;\n      this.router.events.subscribe(this.onRouterNavigate.bind(this));\n    }\n    ngAfterContentInit() {\n      this.init();\n    }\n    /// Stop BackgroundGeolocation and remove all listeners when we navigation back to Home.\n    onRouterNavigate(event) {\n      return _asyncToGenerator(function* () {\n        if (event instanceof NavigationStart) {\n          if (event.url === '/home') {\n            yield BackgroundGeolocation.removeListeners();\n            yield BackgroundGeolocation.stop();\n          }\n        }\n      })();\n    }\n    init() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        // When we return to Home page, stop the plugin and remove all listeners.\n        yield BackgroundGeolocation.stop();\n        yield BackgroundGeolocation.removeListeners();\n        registerTransistorAuthorizationListener(_this.router);\n        _this.orgname = LocalStorage.getItem('orgname');\n        _this.username = LocalStorage.getItem('username');\n        _this.url = environment.TRACKER_HOST;\n        if (_this.isValid(_this.orgname)) {\n          _this.url += '/' + _this.orgname;\n        }\n        _this.deviceInfo = yield BackgroundGeolocation.getDeviceInfo();\n        let identifier = _this.deviceInfo.model;\n        if (_this.username) {\n          identifier += '-' + _this.username;\n        }\n        _this.deviceIdentifier = identifier;\n        if (!_this.isValid(_this.orgname) || !_this.isValid(_this.username)) {\n          _this.onClickRegister();\n        }\n      })();\n    }\n    onClickRegister() {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        const modal = yield _this2.modalController.create({\n          component: RegistrationPage,\n          cssClass: 'my-custom-class',\n          animated: true,\n          componentProps: {\n            'orgname': _this2.orgname,\n            'username': _this2.username\n          }\n        });\n        modal.onDidDismiss().then(result => {\n          // Update our view-state -- BackgroundGeolocation state may have changed in Settings screen.\n          if (result != null && result.data) {\n            _this2.orgname = result.data.orgname;\n            _this2.username = result.data.username;\n            _this2.deviceIdentifier = _this2.deviceInfo.model + '-' + _this2.username;\n          }\n        });\n        yield modal.present();\n      })();\n    }\n    onClickNavigate(app) {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        // Sanity check.\n        if (!_this3.isValid(_this3.orgname) || !_this3.isValid(_this3.username)) {\n          return _this3.onClickRegister();\n        }\n        if (yield _this3.willDiscloseBackgroundPermission(app)) {\n          return;\n        }\n        // Persist the selected page.\n        LocalStorage.setItem('page', app);\n        _this3.router.navigate(['/' + app]);\n      })();\n    }\n    isValid(name) {\n      if (!name || name.length == 0) return false;\n      name = name.replace(/s+/, '');\n      return USERNAME_VALIDATOR.test(name);\n    }\n    /// New Google Play Console requirements for BACKGROUND_LOCATION permission require a one-time\n    /// \"disclosure for background location access\", just a simple Alert with only an [OK] button where\n    /// you declare something \"this app tracks your location in the background for these reasons X, Y and Z\".\n    ///\n    /// See Transistor Blog for more information:\n    ///   https://transistorsoft.medium.com/new-google-play-console-guidelines-for-sensitive-app-permissions-d9d2f4911353\n    ///\n    willDiscloseBackgroundPermission(page) {\n      var _this4 = this,\n        _ref;\n      return new Promise(function (_x, _x2) {\n        return (_ref = _ref || _asyncToGenerator(function* (resolve, reject) {\n          var _ref2;\n          if (!isPlatform('android')) {\n            // Will disclose for iOS devices?  NO!\n            return resolve(false);\n          }\n          const hasDisclosedBackgroundPermission = LocalStorage.getItem('hasDisclosedBackgroundPermission') === 'true';\n          resolve(!hasDisclosedBackgroundPermission);\n          // If we've already disclosed, we're done here.\n          if (hasDisclosedBackgroundPermission) {\n            return;\n          }\n          // Show the one-time disclosure Alert\n          _this4.alertCtrl.create({\n            header: 'Background Location Access',\n            message: 'BG Geo collects location data to enable tracking your trips to work and calculate distance travelled even when the app is closed or not in use.\\n\\nThis data will be uploaded to tracker.transistorsoft.com where you may view and/or delete your location history.',\n            buttons: [{\n              text: 'Close',\n              handler: e => {\n                // Now set a flag that we've disclosed to the user so this alert never gets shown again.\n                LocalStorage.setItem('hasDisclosedBackgroundPermission', 'true');\n                // And continue along with routing to the desired Page...\n                _this4.onClickNavigate(page);\n              }\n            }],\n            backdropDismiss: false,\n            cssClass: 'background-location-disclosure'\n          }).then(function (_x3) {\n            return (_ref2 = _ref2 || _asyncToGenerator(function* (alert) {\n              alert.present();\n            })).apply(this, arguments);\n          });\n        })).apply(this, arguments);\n      });\n    }\n  }\n  _class = HomePage;\n  _class.ɵfac = function HomePage_Factory(t) {\n    return new (t || _class)(i0.ɵɵdirectiveInject(i1.ModalController), i0.ɵɵdirectiveInject(i1.AlertController), i0.ɵɵdirectiveInject(i1.Platform), i0.ɵɵdirectiveInject(i2.Router));\n  };\n  _class.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: _class,\n    selectors: [[\"app-home\"]],\n    decls: 41,\n    vars: 5,\n    consts: [[\"color\", \"tertiary\"], [\"mode\", \"ios\", \"color\", \"dark\"], [\"padding\", \"\", \"color\", \"dark\"], [2, \"text-align\", \"center\"], [\"expand\", \"full\", \"shape\", \"round\", \"color\", \"tertiary\", 3, \"click\"], [2, \"padding\", \"10px\"], [3, \"innerHTML\"], [\"color\", \"primary\", \"position\", \"fixed\"], [\"readonly\", \"true\", 3, \"ngModel\", \"ngModelChange\"], [\"position\", \"fixed\", \"color\", \"primary\"], [\"align-self-start\", \"\", 2, \"padding-right\", \"5px\"], [\"expand\", \"full\", \"color\", \"danger\", 3, \"click\"], [\"align-self-end\", \"\", 2, \"padding-right\", \"5px\"], [2, \"text-decoration\", \"none\", 3, \"href\"], [\"expand\", \"full\", \"color\", \"primary\"]],\n    template: function HomePage_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"ion-header\")(1, \"ion-toolbar\", 0)(2, \"ion-title\", 1);\n        i0.ɵɵtext(3, \"BG Geolocation\");\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelementStart(4, \"ion-content\", 2)(5, \"ion-grid\")(6, \"ion-row\")(7, \"ion-col\")(8, \"h1\", 3);\n        i0.ɵɵtext(9, \"Example Applications\");\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelementStart(10, \"ion-row\")(11, \"ion-col\")(12, \"ion-button\", 4);\n        i0.ɵɵlistener(\"click\", function HomePage_Template_ion_button_click_12_listener() {\n          return ctx.onClickNavigate(\"hello-world\");\n        });\n        i0.ɵɵtext(13, \"Hello World\");\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelementStart(14, \"ion-row\")(15, \"ion-col\")(16, \"ion-button\", 4);\n        i0.ɵɵlistener(\"click\", function HomePage_Template_ion_button_click_16_listener() {\n          return ctx.onClickNavigate(\"advanced\");\n        });\n        i0.ɵɵtext(17, \"Advanced\");\n        i0.ɵɵelementEnd()()()()();\n        i0.ɵɵelementStart(18, \"ion-footer\")(19, \"p\", 5);\n        i0.ɵɵtext(20, \" These apps will post locations to Transistor Software's demo server. You can view your tracking in the browser by visiting:\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(21, \"p\", 3)(22, \"i\", 6);\n        i0.ɵɵtext(23, \"/\");\n        i0.ɵɵelement(24, \"strong\", 6);\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(25, \"ion-item\")(26, \"ion-label\", 7);\n        i0.ɵɵtext(27, \"Organization:\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(28, \"ion-input\", 8);\n        i0.ɵɵlistener(\"ngModelChange\", function HomePage_Template_ion_input_ngModelChange_28_listener($event) {\n          return ctx.orgname = $event;\n        });\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(29, \"ion-item\")(30, \"ion-label\", 9);\n        i0.ɵɵtext(31, \"Device ID:\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(32, \"ion-input\", 8);\n        i0.ɵɵlistener(\"ngModelChange\", function HomePage_Template_ion_input_ngModelChange_32_listener($event) {\n          return ctx.deviceIdentifier = $event;\n        });\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(33, \"ion-row\")(34, \"ion-col\", 10)(35, \"ion-button\", 11);\n        i0.ɵɵlistener(\"click\", function HomePage_Template_ion_button_click_35_listener() {\n          return ctx.onClickRegister();\n        });\n        i0.ɵɵtext(36, \"Register\");\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(37, \"ion-col\", 12)(38, \"a\", 13)(39, \"ion-button\", 14);\n        i0.ɵɵtext(40, \"View Server\");\n        i0.ɵɵelementEnd()()()()();\n      }\n      if (rf & 2) {\n        i0.ɵɵadvance(22);\n        i0.ɵɵproperty(\"innerHTML\", ctx.url, i0.ɵɵsanitizeHtml);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"innerHTML\", ctx.orgname, i0.ɵɵsanitizeHtml);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngModel\", ctx.orgname);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngModel\", ctx.deviceIdentifier);\n        i0.ɵɵadvance(6);\n        i0.ɵɵproperty(\"href\", ctx.url, i0.ɵɵsanitizeUrl);\n      }\n    },\n    dependencies: [i3.NgControlStatus, i3.NgModel, i1.IonButton, i1.IonCol, i1.IonContent, i1.IonFooter, i1.IonGrid, i1.IonHeader, i1.IonInput, i1.IonItem, i1.IonLabel, i1.IonRow, i1.IonTitle, i1.IonToolbar, i1.TextValueAccessor],\n    styles: [\"app-home[_ngcontent-%COMP%]{border:5px solid red}#container[_ngcontent-%COMP%]{text-align:center;position:absolute;left:0;right:0;top:50%;transform:translateY(-50%)}#container[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:20px;line-height:26px}#container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:16px;line-height:22px;color:#8c8c8c;margin:0}#container[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{text-decoration:none}\"]\n  });\n  return HomePage;\n})();\nexport { HomePage };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}